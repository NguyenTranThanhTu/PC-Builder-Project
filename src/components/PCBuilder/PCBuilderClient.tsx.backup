
"use client";
import React, { useEffect, useMemo, useState } from "react";
import { formatVnd } from "@/lib/formatVnd";
import { useAppDispatch } from "@/redux/useAppDispatch";
import { addItemToCart, removeItemFromCart, updateCartItemQuantity } from "@/redux/features/cart-slice";
import { useAppSelector } from "@/redux/store";
import { CpuChipIcon, DevicePhoneMobileIcon, ServerStackIcon, BoltIcon, RectangleStackIcon, CubeTransparentIcon, Squares2X2Icon, FireIcon, CheckCircleIcon, ExclamationTriangleIcon, XCircleIcon, InformationCircleIcon, ChevronDownIcon, ChevronUpIcon, LightBulbIcon } from '@heroicons/react/24/outline';

type SimpleProduct = {
  id: string;
  name: string;
  slug: string;
  priceCents: number;
  imageUrl?: string | null;
  imageBlurData?: string | null;
};


const TARGET_CATEGORIES = [
  "cpu",
  "mainboard",
  "gpu",
  "ram",
  "psu",
  "case",
  "storage",
  "cooler",
];

const CATEGORY_ICONS: Record<string, any> = {
  cpu: CpuChipIcon,
  mainboard: ServerStackIcon,
  gpu: Squares2X2Icon, // D√πng icon l∆∞·ªõi cho GPU (t∆∞·ª£ng tr∆∞ng cho ƒëa nh√¢n/ƒëa lu·ªìng)
  ram: RectangleStackIcon, // RAM d√πng RectangleStackIcon
  psu: BoltIcon,
  case: CubeTransparentIcon,
  storage: RectangleStackIcon, // Storage d√πng RectangleStackIcon (·ªï c·ª©ng d·∫°ng stack)
  cooler: FireIcon,
};

function price(p: SimpleProduct) {
  return (p.priceCents || 0) / 100;
}


export default function PCBuilderClient() {
  const dispatch = useAppDispatch();
  const [selected, setSelected] = useState<Record<string, SimpleProduct | null>>({});
  const [search, setSearch] = useState<Record<string, string>>({});
  const [searchResults, setSearchResults] = useState<Record<string, SimpleProduct[]>>({});
  const [suggestions, setSuggestions] = useState<Record<string, SimpleProduct[]>>({});
  const [loadingSuggest, setLoadingSuggest] = useState(false);
  const [checking, setChecking] = useState(false);
  const [issues, setIssues] = useState<{ 
    severity: "error" | "warning" | "info";
    message: string; 
    details?: string;
    recommendation?: string;
    leftProductId?: string; 
    leftProductName?: string;
    rightProductId?: string;
    rightProductName?: string;
    affectedComponents?: string[];
  }[]>([]);
  const [checkResultOpen, setCheckResultOpen] = useState(false);
  const [checkError, setCheckError] = useState<string | null>(null);
  const [expandedIssues, setExpandedIssues] = useState<Set<number>>(new Set());
  
  const cartItems = useAppSelector(state => state.cartReducer.items);

  const selectedIds = useMemo(
    () => Object.values(selected).filter(Boolean).map((p) => (p as SimpleProduct).id),
    [selected]
  );

  useEffect(() => {
    fetchSuggestions();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedIds.join(",")]);

  async function fetchSuggestions() {
    setLoadingSuggest(true);
    try {
      const res = await fetch("/api/compatibility/suggest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productIds: selectedIds, maxPerCategory: 8 }),
      });
      const data = await res.json();
      setSuggestions(data.suggestions || {});
    } catch (e) {
      console.error(e);
    } finally {
      setLoadingSuggest(false);
    }
  }

  async function checkCompatibility() {
    setChecking(true);
    setCheckError(null);
    setIssues([]);
    setCheckResultOpen(false);
    try {
      const res = await fetch("/api/compatibility/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productIds: selectedIds }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "ƒê√°nh gi√° th·∫•t b·∫°i");
      setIssues(data.issues || []);
      setCheckResultOpen(true);
    } catch (e: any) {
      setCheckError(e.message);
    } finally {
      setChecking(false);
    }
  }

  async function runSearch(slug: string) {
    const q = search[slug] || "";
    const url = new URL("/api/products", window.location.origin);
    url.searchParams.set("category", slug);
    if (q) url.searchParams.set("q", q);
    url.searchParams.set("pageSize", "20");
    const res = await fetch(url);
    const data = await res.json();
    setSearchResults((prev) => ({ ...prev, [slug]: data.items || [] }));
  }

  function selectProduct(slug: string, p: SimpleProduct) {
    // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu v·ªÅ ƒë√∫ng ƒë·ªãnh d·∫°ng SimpleProduct n·∫øu thi·∫øu name ho·∫∑c priceCents
    const prod: any = p;
    const safeProduct: SimpleProduct = {
      id: prod.id,
      name: prod.name || prod.title || "S·∫£n ph·∫©m kh√¥ng t√™n",
      slug: prod.slug || prod.productSlug || "",
      priceCents: typeof prod.priceCents === "number" ? prod.priceCents : Math.round((prod.price || prod.discountedPrice || 0) * 100),
      imageUrl: prod.imageUrl || (prod.imgs?.thumbnails?.[0] ?? null),
      imageBlurData: prod.imageBlurData ?? null,
    };
    setSelected((prev) => ({ ...prev, [slug]: safeProduct }));
    // ƒê·∫£m b·∫£o id l√† string
    const idStr = String(safeProduct.id);
    // Debug chi ti·∫øt s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn
    console.log('[PCBuilder] Ch·ªçn s·∫£n ph·∫©m:', {
      id: safeProduct.id,
      name: safeProduct.name,
      priceCents: safeProduct.priceCents,
      imageUrl: safeProduct.imageUrl,
      slug: safeProduct.slug,
      full: safeProduct
    });
    if (!safeProduct.name) console.warn(`[PCBuilder] S·∫£n ph·∫©m thi·∫øu t√™n:`, safeProduct);
    if (!safeProduct.priceCents && safeProduct.priceCents !== 0) console.warn(`[PCBuilder] S·∫£n ph·∫©m thi·∫øu gi√° ti·ªÅn:`, safeProduct);
    const cartItem = {
      id: idStr,
      title: safeProduct.name,
      price: safeProduct.priceCents / 100,
      discountedPrice: safeProduct.priceCents / 100,
      quantity: 1,
      imgs: safeProduct.imageUrl ? { thumbnails: [safeProduct.imageUrl], previews: [safeProduct.imageUrl] } : undefined,
      productId: idStr,
    };
    console.log('[PCBuilder] Dispatch addItemToCart:', cartItem);
    dispatch(addItemToCart(cartItem));
    setTimeout(() => {
      // Type guard for Redux DevTools Extension
      const devtools = (window as any).__REDUX_DEVTOOLS_EXTENSION__;
      const state = devtools ? devtools.getState() : null;
      console.log('[PCBuilder] State sau khi th√™m v√†o cart:', state);
    }, 500);
  }
  
  function clearProduct(slug: string, id: string) {
    setSelected((prevState) => ({ ...prevState, [slug]: null }));
    const cartItemId = String(id);
    const found = cartItems.find(item => item.id === cartItemId);
    if (found && found.quantity > 1) {
      dispatch(updateCartItemQuantity({ id: cartItemId, quantity: found.quantity - 1 }));
    } else if (found) {
      dispatch(removeItemFromCart(cartItemId));
    }
  }

  // Progress bar t√≠nh ph·∫ßn trƒÉm ƒë√£ ch·ªçn
  const progress = Math.round((selectedIds.length / TARGET_CATEGORIES.length) * 100);

  // NOTE: Ch·ªâ s·ª≠ d·ª•ng c√°c m√†u ƒë√£ ƒë·ªãnh nghƒ©a trong tailwind.config.ts (vd: from-blue, to-blue-dark, from-green, to-blue, v.v.).
  // N·∫øu d√πng m√†u kh√¥ng c√≥ trong config (vd: from-blue-500, to-cyan-500, to-purple-600, v.v.), Tailwind s·∫Ω fallback v·ªÅ tr·∫Øng ho·∫∑c kh√¥ng render gradient ƒë√∫ng.
  // Nguy√™n nh√¢n c√°c n√∫t/icon b·ªã tr·∫Øng l√† do d√πng class m√†u kh√¥ng t·ªìn t·∫°i trong config custom.
  return (
    <div className="w-full min-h-screen bg-gradient-to-br from-blue-dark via-blue to-blue-light py-12 px-2 md:px-0 flex flex-col items-center">
      <div className="max-w-4xl w-full mx-auto">
        <h1 className="text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow">PC Builder</h1>
        <p className="text-lg text-indigo-100 mb-6">Ch·ªçn linh ki·ªán theo t·ª´ng nh√≥m. H·ªá th·ªëng s·∫Ω g·ª£i √Ω c√°c linh ki·ªán c√≤n thi·∫øu v√† ƒë·∫£m b·∫£o t∆∞∆°ng th√≠ch.</p>

        {/* Progress bar */}
        <div className="w-full bg-white/20 rounded-full h-4 mb-8 shadow-inner">
          <div className="bg-gradient-to-r from-green to-blue h-4 rounded-full transition-all duration-500" style={{ width: `${progress}%` }} />
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {TARGET_CATEGORIES.map((slug) => {
            const sel = selected[slug];
            const Icon = CATEGORY_ICONS[slug] || CubeTransparentIcon;
            // Ki·ªÉm tra tr·∫°ng th√°i t∆∞∆°ng th√≠ch cho t·ª´ng nh√≥m
              let statusIcon = null;
              let statusColor = "";
            if (sel) {
              // N·∫øu kh√¥ng c√≥ l·ªói li√™n quan ƒë·∫øn nh√≥m n√†y => check xanh
              const hasIssue = issues.some(i => {
                if (!i.leftProductId && !i.rightProductId) return false;
                return (
                  (sel.id && (i.leftProductId === sel.id || i.rightProductId === sel.id))
                );
              });
              if (hasIssue) {
                statusIcon = <ExclamationTriangleIcon className="w-5 h-5 text-yellow-400" title="C√≥ v·∫•n ƒë·ªÅ t∆∞∆°ng th√≠ch" />;
                statusColor = "ring-2 ring-yellow-400";
              } else {
                statusIcon = <CheckCircleIcon className="w-5 h-5 text-green-500" title="T∆∞∆°ng th√≠ch" />;
                statusColor = "ring-2 ring-green-400";
              }
            }
            // Determine highlight color for selected product
            let cardBg = 'bg-white/70 backdrop-blur border-blue-100 hover:border-blue-400';
            if (sel) {
              const hasIssue = issues.some(i => {
                if (!i.leftProductId && !i.rightProductId) return false;
                return (
                  (sel.id && (i.leftProductId === sel.id || i.rightProductId === sel.id))
                );
              });
              if (hasIssue) {
                cardBg = 'bg-gradient-to-br from-red-light to-red/80 border-red';
              } else {
                cardBg = 'bg-gradient-to-br from-green-light to-green/80 border-green';
              }
            }
            return (
              <div
                key={slug}
                className={`rounded-2xl shadow-2xl p-5 flex flex-col gap-2 border transition-all duration-300 group relative overflow-hidden animate-fade-in ${cardBg}`}
              >
                <div className="flex items-center gap-3 mb-2">
                      <span className={`inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-700 text-white shadow-2xl border-2 border-blue-400 group-hover:scale-110 transition-transform duration-300 relative z-10 ${statusColor}`}
                        style={{ boxShadow: '0 6px 24px 0 rgba(30,64,175,0.22)' }}
                    title={sel ? (statusIcon ? (statusColor.includes('green') ? 'T∆∞∆°ng th√≠ch' : 'C√≥ v·∫•n ƒë·ªÅ t∆∞∆°ng th√≠ch') : '') : 'Ch∆∞a ch·ªçn'}
                  >
                    <Icon className="w-7 h-7 drop-shadow" />
                    {sel && statusIcon && (
                      <span className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-lg z-20 border border-blue-200">
                        {statusIcon}
                      </span>
                    )}
                  </span>
                  <h3 className="text-xl font-semibold text-gray-800 tracking-wide uppercase">{slug}</h3>
                  {sel && (
                    <button
                      className="ml-auto px-2 py-1 rounded bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-semibold hover:brightness-110 transition shadow-lg border border-red-200"
                      onClick={() => sel && clearProduct(slug, sel.id)}
                      title="B·ªè ch·ªçn linh ki·ªán"
                      style={{ zIndex: 10 }}
                    >X√≥a</button>
                  )}
                </div>
                <div className="flex-1">
                  {sel ? (
                    <div className="flex items-center gap-3 animate-fade-in">
                      {sel.imageUrl && (
                        <img src={sel.imageUrl} alt={sel.name} className="w-14 h-14 object-contain rounded-lg border bg-gray-50" />
                      )}
                      <div>
                        <div className="text-base font-medium text-gray-900">{sel.name}</div>
                        <div className="text-xs text-gray-500">{formatVnd(price(sel))}</div>
                      </div>
                    </div>
                  ) : (
                    <>
                      <div className="flex gap-2 mb-2">
                        <input
                          placeholder={`T√¨m ${slug}...`}
                          className="border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-300 outline-none"
                          value={search[slug] || ""}
                          onChange={(e) => setSearch((p) => ({ ...p, [slug]: e.target.value }))}
                          title={`T√¨m ki·∫øm ${slug}`}
                        />
                        <button className="px-3 py-2 rounded-full bg-gradient-to-r from-blue to-cyan text-white font-bold shadow-lg border-2 border-blue-light hover:scale-105 hover:shadow-blue/50 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue" onClick={() => runSearch(slug)} title="T√¨m linh ki·ªán">T√¨m</button>
                      </div>
                      <div className="grid grid-cols-1 gap-2 max-h-48 overflow-auto">
                        {(searchResults[slug] || []).map((p) => {
                          const prod: any = p;
                          const safeProduct: SimpleProduct = {
                            id: prod.id,
                            name: prod.name || prod.title || "S·∫£n ph·∫©m kh√¥ng t√™n",
                            slug: prod.slug || prod.productSlug || "",
                            priceCents: typeof prod.priceCents === "number" ? prod.priceCents : Math.round((prod.price || prod.discountedPrice || 0) * 100),
                            imageUrl: prod.imageUrl || (prod.imgs?.thumbnails?.[0] ?? null),
                            imageBlurData: prod.imageBlurData ?? null,
                          };
                          return (
                            <button key={safeProduct.id} onClick={() => selectProduct(slug, safeProduct)} className="flex items-center gap-3 text-left border rounded p-2 hover:bg-blue-50 transition group animate-fade-in" title={`Ch·ªçn ${safeProduct.name}`}>
                              <img src={safeProduct.imageUrl || "/images/products/product-1-sm-1.png"} className="w-12 h-12 object-cover rounded" />
                              <div>
                                <div className="text-sm font-medium text-gray-800">{safeProduct.name}</div>
                                <div className="text-xs text-gray-500">{formatVnd(safeProduct.priceCents / 100)}</div>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                      {/* G·ª£i √Ω linh ki·ªán n·∫øu c√≥ */}
                      {suggestions[slug]?.length ? (
                        <div className="mt-3">
                          <div className="text-sm font-medium mb-1 text-blue-700">G·ª£i √Ω</div>
                          <div className="grid grid-cols-1 gap-2">
                            {suggestions[slug].map((p) => (
                              <button key={p.id} onClick={() => selectProduct(slug, p)} className="flex items-center gap-3 text-left border rounded p-2 hover:bg-green-50 transition group animate-fade-in" title={`Ch·ªçn g·ª£i √Ω ${p.name}`}>
                                <img src={p.imageUrl || "/images/products/product-1-sm-1.png"} className="w-12 h-12 object-cover rounded" />
                                <div>
                                  <div className="text-sm font-medium text-gray-800">{p.name}</div>
                                  <div className="text-xs text-gray-500">{formatVnd(price(p))}</div>
                                </div>
                              </button>
                            ))}
                          </div>
                        </div>
                      ) : null}
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        <div className="mt-10 flex flex-col gap-3 items-center">
          <div className="flex items-center gap-3">
            <button className="px-5 py-2 rounded-full bg-gradient-to-r from-blue-dark to-blue text-white font-bold shadow-2xl hover:scale-105 hover:shadow-blue-dark/50 transition-all duration-200 border-2 border-blue-dark focus:outline-none focus:ring-2 focus:ring-blue-dark" onClick={fetchSuggestions} disabled={loadingSuggest}>
              {loadingSuggest ? "ƒêang g·ª£i √Ω..." : "L√†m m·ªõi g·ª£i √Ω"}
            </button>
            <button
              className={`px-5 py-2 rounded-full font-bold shadow-2xl transition-all duration-200 border-2 focus:outline-none focus:ring-2
                ${checking ? 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-white border-yellow-400 focus:ring-yellow-400' :
                  checkResultOpen ? (issues.length === 0
                    ? 'bg-gradient-to-r from-green to-green-light text-white border-green focus:ring-green'
                    : 'bg-gradient-to-r from-red to-red-light text-white border-red focus:ring-red')
                  : 'bg-gradient-to-r from-purounded-xl p-6 shadow-2xl w-full max-w-3xl animate-fade-in border-2 border-blue-200">
              <div className="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
                <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <BoltIcon className="w-6 h-6 text-blue-500" />
                  K·∫øt qu·∫£ ki·ªÉm tra t∆∞∆°ng th√≠ch
                </h3>
                <button 
                  onClick={() => setCheckResultOpen(false)} 
                  className="text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-3 py-1 rounded-lg transition-colors font-medium"
                >
                  ƒê√≥ng ‚úï
                </button>
              </div>
              
              {issues.length === 0 ? (
                <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-xl p-5 flex items-start gap-4 shadow-sm">
                  <div className="flex-shrink-0">
                    <CheckCircleIcon className="w-10 h-10 text-green-500" />
                  </div>
                  <div>
                    <h4 className="text-lg font-bold text-green-800 mb-1">‚úì Ho√†n h·∫£o!</h4>
                    <p className="text-green-700 text-base">T·∫•t c·∫£ linh ki·ªán ƒë√£ ch·ªçn ƒë·ªÅu t∆∞∆°ng th√≠ch ho√†n to√†n. B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c th√™m v√†o gi·ªè h√†ng v√† thanh to√°n.</p>
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  {/* Summary badges */}
                  <div className="flex items-center gap-3 mb-4 flex-wrap">
                    <span className="text-sm font-semibold text-gray-700">T√≥m t·∫Øt:</span>
                    {issues.filter(i => i.severity === "error").length > 0 && (
                      <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold border border-red-300">
                        <XCircleIcon className="w-4 h-4" />
                        {issues.filter(i => i.severity === "error").length} l·ªói nghi√™m tr·ªçng
                      </span>
                    )}
                    {issues.filter(i => i.severity === "warning").length > 0 && (
                      <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-semibold border border-yellow-300">
                        <ExclamationTriangleIcon className="w-4 h-4" />
                        {issues.filter(i => i.severity === "warning").length} c·∫£nh b√°o
                      </span>
                    )}
                    {issues.filter(i => i.severity === "info").length > 0 && (
                      <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold border border-blue-300">
                        <InformationCircleIcon className="w-4 h-4" />
                        {issues.filter(i => i.severity === "info").length} g·ª£i √Ω
                      </span>
                    )}
                  </div>

                  {/* Issues list */}
                  <div className="space-y-3">
                    {issues.map((issue, idx) => {
                      const isExpanded = expandedIssues.has(idx);
                      const hasDetails = issue.details || issue.recommendation;
                      
                      // Determine severity styling
                      let severityConfig = {
                        bgClass: "bg-gradient-to-br from-red-50 to-rose-50",
                        borderClass: "border-red-400",
                        iconBgClass: "bg-red-500",
                        textClass: "text-red-800",
                        subtextClass: "text-red-700",
                        badgeClass: "bg-red-100 text-red-800 border-red-300",
                        icon: <XCircleIcon className="w-6 h-6 text-white" />,
                        label: "L·ªñI",
                        badgeIcon: "üö´"
                      };

                      if (issue.severity === "warning") {
                        severityConfig = {
                          bgClass: "bg-gradient-to-br from-yellow-50 to-amber-50",
                          borderClass: "border-yellow-400",
                          iconBgClass: "bg-yellow-500",
                          textClass: "text-yellow-900",
                          subtextClass: "text-yellow-800",
                          badgeClass: "bg-yellow-100 text-yellow-800 border-yellow-300",
                          icon: <ExclamationTriangleIcon className="w-6 h-6 text-white" />,
                          label: "C·∫¢NH B√ÅO",
                          badgeIcon: "‚ö†Ô∏è"
                        };
                      } else if (issue.severity === "info") {
                        severityConfig = {
                          bgClass: "bg-gradient-to-br from-blue-50 to-cyan-50",
                          borderClass: "border-blue-400",
                          iconBgClass: "bg-blue-500",
                          textClass: "text-blue-900",
                          subtextClass: "text-blue-800",
                          badgeClass: "bg-blue-100 text-blue-800 border-blue-300",
                          icon: <InformationCircleIcon className="w-6 h-6 text-white" />,
                          label: "G·ª¢I √ù",
                          badgeIcon: "üí°"
                        };
                      }

                      return (
                        <div 
                          key={idx} 
                          className={`${severityConfig.bgClass} border-2 ${severityConfig.borderClass} rounded-xl shadow-md overflow-hidden transition-all duration-200 hover:shadow-lg`}
                        >
                          {/* Issue Header */}
                          <div className="p-4">
                            <div className="flex items-start gap-3">
                              {/* Icon */}
                              <div className={`flex-shrink-0 ${severityConfig.iconBgClass} rounded-full p-2 shadow-lg`}>
                                {severityConfig.icon}
                              </div>
                              
                              {/* Content */}
                              <div className="flex-1 min-w-0">
                                {/* Severity badge and affected components */}
                                <div className="flex items-center gap-2 mb-2 flex-wrap">
                                  <span className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-md text-xs font-bold border ${severityConfig.badgeClass} shadow-sm`}>
                                    {severityConfig.badgeIcon} {severityConfig.label}
                                  </span>
                                  {issue.affectedComponents && issue.affectedComponents.length > 0 && (
                                    <div className="flex items-center gap-1.5 flex-wrap">
                                      {issue.affectedComponents.map((comp, i) => (
                                        <span 
                                          key={i}
                                          className="inline-flex items-center px-2 py-0.5 rounded-md bg-white/70 border border-gray-300 text-xs font-medium text-gray-700 shadow-sm"
                                        >
                                          {comp.toUpperCase()}
                                        </span>
                                      ))}
                                    </div>
                                  )}
                                </div>

                                {/* Main message */}
                                <p className={`text-base font-semibold ${severityConfig.textClass} leading-tight mb-1`}>
                                  {issue.message}
                                </p>

                                {/* Product names if available */}
                                {(issue.leftProductName || issue.rightProductName) && (
                                  <div className="flex items-center gap-2 mt-2 text-xs text-gray-600 flex-wrap">
                                    {issue.leftProductName && (
                                      <span className="inline-flex items-center px-2 py-1 bg-white/80 rounded border border-gray-300 font-medium">
                                        {issue.leftProductName}
                                      </span>
                                    )}
                                    {issue.leftProductName && issue.rightProductName && (
                                      <span className="text-gray-400">√ó</span>
                                    )}
                                    {issue.rightProductName && (
                                      <span className="inline-flex items-center px-2 py-1 bg-white/80 rounded border border-gray-300 font-medium">
                                        {issue.rightProductName}
                                      </span>
                                    )}
                                  </div>
                                )}
                              </div>

                              {/* Expand button */}
                              {hasDetails && (
                                <button
                                  onClick={() => {
                                    const newExpanded = new Set(expandedIssues);
                                    if (isExpanded) {
                                      newExpanded.delete(idx);
                                    } else {
                                      newExpanded.add(idx);
                                    }
                                    setExpandedIssues(newExpanded);
                                  }}
                                  className={`flex-shrink-0 p-1.5 rounded-lg transition-all hover:bg-white/50 ${severityConfig.textClass}`}
                                  title={isExpanded ? "Thu g·ªçn" : "Xem chi ti·∫øt"}
                                >
                                  {isExpanded ? (
                                    <ChevronUpIcon className="w-5 h-5" />
                                  ) : (
                                    <ChevronDownIcon className="w-5 h-5" />
                                  )}
                                </button>
                              )}
                            </div>
                          </div>

                          {/* Expanded Details */}
                          {isExpanded && hasDetails && (
                            <div className="px-4 pb-4 space-y-3 animate-fade-in">
                              {/* Details section */}
                              {issue.details && (
                                <div className="bg-white/60 backdrop-blur-sm border border-gray-300 rounded-lg p-3 shadow-sm">
                                  <div className="flex items-center gap-2 mb-2">
                                    <InformationCircleIcon className="w-4 h-4 text-gray-600" />
                                    <h5 className="text-sm font-bold text-gray-800">Chi ti·∫øt k·ªπ thu·∫≠t:</h5>
                                  </div>
                                  <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-line">
                                    {issue.details}
                                  </p>
                                </div>
                              )}

                              {/* Recommendation section */}
                              {issue.recommendation && (
                                <div className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-3 shadow-sm">
                                  <div className="flex items-center gap-2 mb-2">
                                    <LightBulbIcon className="w-5 h-5 text-green-600" />
                                    <h5 className="text-sm font-bold text-green-800">üí° Gi·∫£i ph√°p ƒë·ªÅ xu·∫•t:</h5>
                                  </div>
                                  <p className="text-sm text-green-800 leading-relaxed whitespace-pre-line font-medium">
                                    {issue.recommendation}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </divn onClick={() => setCheckResultOpen(false)} className="text-[13px] text-blue-500 hover:underline">ƒê√≥ng</button>
              </div>
              {issues.length === 0 ? (
                <div className="text-green-700 text-base flex items-center gap-2"><span className="inline-block w-3 h-3 rounded-full bg-green-400 animate-pulse"></span>T·∫•t c·∫£ linh ki·ªán ƒë√£ ch·ªçn ƒë·ªÅu t∆∞∆°ng th√≠ch!</div>
              ) : (
                <div>
                  <p className="text-sm font-medium mb-1 text-red-600 flex items-center gap-2"><FireIcon className="w-4 h-4 text-red-400" />V·∫•n ƒë·ªÅ:</p>
                  <ul className="space-y-1">
                    {issues.map((i, idx) => (
                      <li key={idx} className="text-sm text-red-600 flex items-center gap-2"><span className="inline-block w-2 h-2 rounded-full bg-red-400"></span>{i.message}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

